# =============================================================================
# ML Sport Stat Predictor - Redis Configuration
# =============================================================================
# Redis 7.x Configuration for caching and session management
# Optimized for both development and production environments

# =============================================================================
# Network Configuration
# =============================================================================
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# =============================================================================
# General Configuration
# =============================================================================
daemonize no
supervised no
loglevel notice
databases 16

# =============================================================================
# Security
# =============================================================================
# Password is set via command line argument in docker-compose
# requirepass will be set via --requirepass flag

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# =============================================================================
# Memory Management
# =============================================================================
# Memory limit (overridden by command line in docker-compose)
maxmemory 512mb

# Eviction policy - LRU (Least Recently Used) for all keys
# Options: noeviction, allkeys-lru, allkeys-lfu, volatile-lru, volatile-lfu, volatile-ttl, volatile-random, allkeys-random
maxmemory-policy allkeys-lru

# LRU and LFU algorithm precision
maxmemory-samples 5

# =============================================================================
# Persistence - RDB (Redis Database Backup)
# =============================================================================
# Save the DB on disk:
# save <seconds> <changes>
# Will save the DB if both the given number of seconds and the given
# number of write operations against the DB occurred.

# Save after 15 minutes if at least 1 key changed
save 900 1

# Save after 5 minutes if at least 10 keys changed
save 300 10

# Save after 1 minute if at least 10000 keys changed
save 60 10000

# Compress RDB files
rdbcompression yes

# Checksum RDB files for corruption detection
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory for RDB and AOF files
dir /data

# Stop accepting writes if RDB snapshots fail
stop-writes-on-bgsave-error yes

# =============================================================================
# Persistence - AOF (Append Only File)
# =============================================================================
# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF sync strategy:
# - always: fsync after every write (slow, safest)
# - everysec: fsync once per second (good compromise)
# - no: let OS decide when to fsync (fastest, least safe)
appendfsync everysec

# Prevent fsync during AOF rewrite to avoid disk I/O spikes
no-appendfsync-on-rewrite no

# Automatic AOF rewrite configuration
# Rewrite when AOF file is 100% larger than last rewrite
auto-aof-rewrite-percentage 100

# Minimum size before triggering first rewrite
auto-aof-rewrite-min-size 64mb

# Load truncated AOF file on startup
aof-load-truncated yes

# Use AOF-RDB hybrid persistence for faster restarts
aof-use-rdb-preamble yes

# =============================================================================
# Replication (for future use)
# =============================================================================
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no

# =============================================================================
# Performance Tuning
# =============================================================================
# Disable slow log for development, enable for production debugging
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100

# =============================================================================
# Advanced Configuration
# =============================================================================
# Close connection after client idle for N seconds (0 = disable)
timeout 0

# Enable active memory defragmentation
activedefrag yes
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# IO threads for better multi-core utilization
# io-threads 4
# io-threads-do-reads yes

# =============================================================================
# Client Output Buffer Limits
# =============================================================================
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# Lua Scripting
# =============================================================================
lua-time-limit 5000

# =============================================================================
# Event Notification (for cache invalidation)
# =============================================================================
notify-keyspace-events ""
